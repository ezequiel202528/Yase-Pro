<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YaSe PRO - Login</title>
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
      body { 
        font-family: "Plus Jakarta Sans", sans-serif; 
        background: #000000; /* Fundo Preto */
        height: 100vh; 
        overflow: hidden; 
        color: white; 
      }
      .bg-gradient-custom {
        background: radial-gradient(circle at top right, #1a1a1a, #000000);
      }
      .glass-card { 
        background: rgba(20, 20, 20, 0.8); 
        backdrop-filter: blur(10px); 
        border: 1px solid rgba(251, 191, 36, 0.2); /* Borda Amarela Sutil */
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.8); 
      }
      .login-input { 
        background: #0a0a0a !important; 
        border: 1px solid #333 !important; 
        color: white !important; 
        transition: all 0.3s ease; 
      }
      .login-input:focus { 
        border-color: #fbbf24 !important; /* Foco Amarelo */
        box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1) !important; 
        outline: none; 
      }
      .btn-primary { 
        background: #fbbf24; /* Botão Amarelo */
        color: #000 !important; /* Texto Preto no Botão */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      }
      .btn-primary:hover { 
        transform: translateY(-2px); 
        background: #f59e0b;
        box-shadow: 0 10px 20px -5px rgba(251, 191, 36, 0.4); 
      }
      .text-accent { color: #fbbf24; }
      .border-accent { border-color: #fbbf24; }
      .hidden { display: none; }
      
      .fade-in { animation: fadeIn 0.5s ease-out forwards; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body class="bg-gradient-custom flex items-center justify-center p-4">
    
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]">
      <div class="w-12 h-12 border-4 border-[#fbbf24] border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- CARD PRINCIPAL: LOGIN -->
    <div id="loginCard" class="glass-card w-full max-w-[440px] p-8 rounded-[2.5rem] relative overflow-hidden fade-in hidden">
      <!-- Elemento Decorativo Amarelo -->
      <div class="absolute top-0 right-0 w-32 h-32 bg-[#fbbf24]/10 blur-3xl rounded-full -mr-16 -mt-16"></div>
      
      <div class="text-center mb-10">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-[#fbbf24] mb-4 shadow-lg shadow-[#fbbf24]/20">
          <i class="fas fa-bolt text-4xl text-black"></i>
        </div>
        <h1 class="text-4xl font-black tracking-tighter mb-1">YaSe <span class="text-accent">PRO</span></h1>
        <p class="text-slate-500 font-medium text-xs uppercase tracking-[0.2em]">Gestão de Unidades</p>
      </div>

      <form id="loginForm" class="space-y-4">
        <div class="space-y-1">
          <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">CNPJ da Unidade</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-500"><i class="fas fa-building text-xs"></i></span>
            <input type="text" id="cnpj_login" required class="login-input w-full pl-11 pr-4 py-3 rounded-xl text-sm" placeholder="00.000.000/0001-00" />
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">ID de Acesso</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-500"><i class="fas fa-id-card text-xs"></i></span>
            <input type="text" id="codigo_id" required class="login-input w-full pl-11 pr-4 py-3 rounded-xl text-sm" placeholder="Digite seu ID" />
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Senha de Segurança</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-500"><i class="fas fa-key text-xs"></i></span>
            <input type="password" id="senha" required class="login-input w-full pl-11 pr-4 py-3 rounded-xl text-sm" placeholder="••••••••" />
          </div>
        </div>

        <button type="submit" id="btnLogin" class="btn-primary w-full py-4 rounded-2xl font-black text-sm tracking-widest mt-4 flex items-center justify-center gap-3">
          ENTRAR AGORA <i class="fas fa-arrow-right"></i>
        </button>
      </form>

      <div class="mt-8 pt-4 border-t border-white/5 text-center">
        <button onclick="toggleView('setupCard')" class="text-slate-500 hover:text-[#fbbf24] text-[10px] font-bold transition-colors uppercase tracking-tight">
          Configurar <span class="text-accent underline">Setup Inicial</span> da Empresa
        </button>
      </div>
    </div>

    <!-- CARD: SETUP INICIAL -->
    <div id="setupCard" class="glass-card w-full max-w-[500px] p-8 rounded-[2.5rem] fade-in hidden">
      <div class="mb-8">
        <button onclick="toggleView('loginCard')" class="text-slate-500 hover:text-white mb-6 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest transition-all">
          <i class="fas fa-chevron-left text-accent"></i> Voltar ao login
        </button>
        <h2 class="text-3xl font-black italic uppercase">Setup <span class="text-accent">Empresa</span></h2>
        <p class="text-slate-400 text-sm mt-1">Configure o ecossistema da sua nova unidade.</p>
      </div>

      <form id="setupForm" class="space-y-5">
        <div class="space-y-4">
          <div class="p-4 rounded-2xl bg-white/5 border border-white/5">
             <label class="text-[10px] font-black text-accent uppercase mb-3 block">Dados da Instituição</label>
             <div class="space-y-3">
                <input type="text" id="int_cnpj" placeholder="CNPJ" required class="login-input w-full p-4 rounded-xl text-sm" />
                <input type="text" id="int_fantasia" placeholder="Nome Fantasia" required class="login-input w-full p-4 rounded-xl text-sm" />
             </div>
          </div>
          
          <div class="p-4 rounded-2xl bg-white/5 border border-white/5">
            <label class="text-[10px] font-black text-accent uppercase mb-3 block">Acesso do Gestor Master</label>
            <div class="space-y-3">
               <input type="text" id="int_gestor_nome" placeholder="Nome do Gestor" required class="login-input w-full p-4 rounded-xl text-sm" />
               <div class="grid grid-cols-2 gap-3">
                  <input type="text" id="int_gestor_id" placeholder="ID Acesso" required class="login-input w-full p-4 rounded-xl text-sm" />
                  <input type="password" id="int_gestor_pass" placeholder="Senha" required class="login-input w-full p-4 rounded-xl text-sm" />
               </div>
            </div>
          </div>
        </div>
        <button type="submit" id="btnInt" class="btn-primary w-full py-4 rounded-2xl font-black text-sm tracking-widest mt-4">
          FINALIZAR SETUP <i class="fas fa-check-double ml-2"></i>
        </button>
      </form>
    </div>

    <!-- DIÁLOGOS -->
    <div id="dialogOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4 hidden">
      <div class="bg-[#111] border border-[#fbbf24]/30 w-full max-w-sm rounded-[2rem] p-8 shadow-2xl text-center" id="dialogBox">
        <div id="dialogIcon" class="w-16 h-16 rounded-full flex items-center justify-center mb-6 mx-auto"></div>
        <h3 id="dialogTitle" class="font-black uppercase tracking-tighter text-xl mb-2"></h3>
        <p id="dialogMsg" class="text-slate-400 text-sm mb-8"></p>
        <button onclick="Dialog.close()" class="btn-primary w-full py-4 rounded-xl font-black text-xs uppercase tracking-widest">OK, ENTENDIDO</button>
      </div>
    </div>

    <script>
      // 1. Configuração Supabase (Mantenha suas chaves aqui)
      const SUPABASE_URL = "https://gzojpxgpgjapsegerscb.supabase.co"; 
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6b2pweGdwZ2phcHNlZ2Vyc2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4Nzc2MzUsImV4cCI6MjA4NTQ1MzYzNX0.vSaIuKyEuzNEGxFsawugLwtUpwWqYpCMP_a3JfWrY5s";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // 2. UI
      const Dialog = {
        show(title, msg, type = 'info') {
          const overlay = document.getElementById('dialogOverlay');
          const icon = document.getElementById('dialogIcon');
          document.getElementById('dialogTitle').innerText = title;
          document.getElementById('dialogMsg').innerText = msg;
          
          if(type === 'success') {
            icon.className = "w-16 h-16 rounded-full bg-green-500/10 text-green-500 flex items-center justify-center mb-6 mx-auto";
            icon.innerHTML = '<i class="fas fa-check-circle text-3xl"></i>';
          } else if(type === 'error') {
            icon.className = "w-16 h-16 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center mb-6 mx-auto";
            icon.innerHTML = '<i class="fas fa-exclamation-circle text-3xl"></i>';
          } else {
            icon.className = "w-16 h-16 rounded-full bg-[#fbbf24]/10 text-[#fbbf24] flex items-center justify-center mb-6 mx-auto";
            icon.innerHTML = '<i class="fas fa-info-circle text-3xl"></i>';
          }
          overlay.classList.remove('hidden');
        },
        close() { document.getElementById('dialogOverlay').classList.add('hidden'); }
      };

      function toggleView(targetId) {
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('setupCard').classList.add('hidden');
        document.getElementById(targetId).classList.remove('hidden');
      }

      // 3. Login
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnLogin');
        const cnpj = document.getElementById('cnpj_login').value.trim();
        const cid = document.getElementById('codigo_id').value.trim();
        const pass = document.getElementById('senha').value;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';

        try {
          // Primeiro busca a empresa pelo CNPJ
          const { data: emp, error: errE } = await sb.from('empresas')
            .select('id')
            .eq('cnpj', cnpj)
            .maybeSingle();
          
          if (errE) throw errE;
          if (!emp) throw new Error("CNPJ não encontrado em nossa base.");

          // Agora busca o usuário dentro dessa empresa
          const { data, error } = await sb.from('usu_arios')
            .select('*')
            .eq('empresa_id', emp.id)
            .eq('codigo_id', cid)
            .eq('senha', pass)
            .maybeSingle();

          if (error) throw error;
          if (!data) throw new Error("ID ou Senha incorretos para esta unidade.");

          // Gravar o CNPJ para a próxima vez
          localStorage.setItem('yase_last_cnpj', cnpj);

          const user = data;
          
          if (user.nivel_permissao === 'Gestor' || user.nivel_permissao === 'Gerente') {
            localStorage.setItem('yase_user', JSON.stringify(user));
            Dialog.show("Acesso Liberado", "Bem-vindo ao centro de comando.", "success");
            setTimeout(() => window.location.href = 'Dashboard.html', 1200);
          } else {
            localStorage.setItem('yase_colab', JSON.stringify(user));
            window.location.href = 'PainelColaborador.html';
          }

        } catch (err) {
          Dialog.show("Falha de Login", err.message, "error");
          btn.disabled = false;
          btn.innerHTML = 'ENTRAR AGORA <i class="fas fa-arrow-right"></i>';
        }
      });

      // 4. Setup
      document.getElementById('setupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnInt');
        btn.disabled = true;
        btn.innerText = "REGISTRANDO...";

        try {
          const { data: emp, error: errE } = await sb.from('empresas').insert([{
            cnpj: document.getElementById('int_cnpj').value.trim(),
            nome_fantasia: document.getElementById('int_fantasia').value.trim()
          }]).select().single();

          if(errE) throw new Error("Conexão falhou ou CNPJ duplicado.");

          const { error: errU } = await sb.from('usu_arios').insert([{
            empresa_id: emp.id,
            nome_completo: document.getElementById('int_gestor_nome').value.trim(),
            codigo_id: document.getElementById('int_gestor_id').value.trim(),
            senha: document.getElementById('int_gestor_pass').value,
            nivel_permissao: 'Gestor'
          }]);

          if(errU) throw new Error("Erro ao criar credenciais master.");

          // Ao criar, já deixa salvo o CNPJ
          localStorage.setItem('yase_last_cnpj', document.getElementById('int_cnpj').value.trim());

          Dialog.show("Setup Finalizado", "Sistema pronto. Efetue seu primeiro login.", "success");
          setTimeout(() => location.reload(), 2000);

        } catch (err) {
          Dialog.show("Erro no Setup", err.message, "error");
          btn.disabled = false;
          btn.innerText = "FINALIZAR SETUP";
        }
      });

      window.onload = () => {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('loginCard').classList.remove('hidden');
        
        // Recuperar último CNPJ usado
        const lastCnpj = localStorage.getItem('yase_last_cnpj');
        if (lastCnpj) {
          document.getElementById('cnpj_login').value = lastCnpj;
        }

       
      };
    </script>
  </body>
</html>